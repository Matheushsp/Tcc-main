<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./styles/output.css" />
  <link rel="stylesheet" href="./styles/style.css" />
  <title>Card치pio - Big John Cookies</title>

  <style>
    /* *** estilos essenciais para o demo funcionar bem *** */
    body { font-family: 'Poppins', Arial, sans-serif; margin:0; padding:0; }
    .container { max-width:1100px; margin: 0 auto; padding: 20px; }
    .hotbar { background:#fff; border-bottom:1px solid #eee; padding:12px 0; }
    .logo { font-weight:700; margin-right:16px; text-decoration:none; color:#333; }
    .menu-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:18px; margin-top:18px; }
    .menu-item { background:#fff; border:1px solid #eee; border-radius:10px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    .menu-item img { width:100%; height:150px; object-fit:cover; display:block; }
    .menu-item-content { padding:12px; }
    .menu-item-content h3 { margin:0 0 8px 0; font-size:18px; }
    .price { font-weight:700; margin:6px 0; }
    .add-to-cart-btn { background:#e11d48; color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; width:100%; }
    /* cart modal basic */
    #cart-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999; }
    .modal-content { background:#fff; width:95%; max-width:520px; border-radius:8px; padding:16px; box-shadow: 0 6px 24px rgba(0,0,0,0.2); }
    .cart-item { display:flex; justify-content:space-between; gap:10px; padding:10px 0; align-items:center; border-bottom:1px solid #eee; }
    .remove-from-cart-btn { background:#ff4d4d; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }
    #cart-btn { position:fixed; bottom:20px; right:20px; background:#ef4444; color:#fff; padding:10px 16px; border-radius:8px; border:none; cursor:pointer; z-index:10000; }
    input[type="text"], input[type="tel"], input[type="number"] { padding:8px; border:1px solid #ddd; border-radius:6px; width:100%; box-sizing:border-box; }
    .hidden { display:none; }
  </style>
</head>
<body>

  <nav class="hotbar">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between;">
      <div style="display:flex;align-items:center;">
        <a class="logo" href="#">Big John Cookies</a>
      </div>
      <div>
        <a href="index.html" style="text-decoration:none;color:#23047e">Home</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1 style="text-align:center; margin-top:18px;">Card치pio</h1>

    <!-- container onde ser칚o inseridos os produtos vindos do banco -->
    <div class="menu-grid" id="menu-list"></div>
  </div>

  <!-- Modal do Carrinho -->
  <div id="cart-modal" class="hidden" aria-hidden="true">
    <div class="modal-content">
      <h2 style="text-align:center; margin:0 0 12px 0;">Meu Carrinho</h2>

      <div id="cart-items" style="max-height:300px; overflow:auto;"></div>

      <p style="font-weight:700; margin-top:12px;">Total: <span id="cart-total">R$ 0,00</span></p>

      <input id="cliente-nome" type="text" placeholder="Seu nome" class="mb-2" style="margin-top:8px;" />
      <input id="cliente-telefone" type="tel" placeholder="Seu telefone" class="mb-2" style="margin-top:8px;" />

      <p style="font-weight:700; margin-top:12px;">Endere칞o de entrega:</p>
      <input type="text" placeholder="Digite seu endere칞o completo..." id="address" style="margin-top:8px;" />
      <p class="text-red-500 hidden" id="address-warn" style="color:#b91c1c; margin:6px 0 0 0;">Digite seu endere칞o completo!</p>

      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:12px;">
        <button id="close-modal-btn" style="padding:8px 12px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer;">Fechar</button>
        <button id="checkout-btn" style="padding:8px 12px; border-radius:6px; background:#16a34a; color:#fff; border:none; cursor:pointer;">Finalizar Pedido</button>
      </div>
    </div>
  </div>

  <button id="cart-btn">Carrinho (<span id="cart-count">0</span>)</button>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <script>
  (function () {
    // ====== Config ======
    const API_PRODUTOS = "/api/produtos"; // localhost route
    const API_PEDIDO = "https://tcc-uh9r.onrender.com/pedido"; // mantive seu endpoint original
    // ====================

    // estado do carrinho
    let cart = []; // { id, name, price, quantity }
    let total = 0;

    // helper: formatar BRL
    function formatBRL(value) {
      return Number(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // carregar produtos do backend e renderizar
    async function carregarProdutos() {
      try {
        const resp = await fetch("https://tcc-uh9r.onrender.com/api/produtos");

        if (!resp.ok) throw new Error('Erro ao buscar produtos: ' + resp.status);
        const lista = await resp.json();
        const menuList = document.getElementById("menu-list");
        menuList.innerHTML = "";

        // se quiser mapear imagens por id/nome, altere aqui; por enquanto uso imagem padr칚o por 칤ndice
        const imagens = [
          './assets/cookies1.jpg',
          './assets/cookies2.jpg',
          './assets/cookies3.jpg',
          './assets/cookies4.jpg'
        ];

        lista.forEach((p, idx) => {
          const imgSrc = imagens[idx % imagens.length]; // gira imagens se tiver mais produtos
          const preco = Number(p.preco).toFixed(2);
          const card = document.createElement('div');
          card.className = 'menu-item';
          card.innerHTML = `
            <img src="${imgSrc}" alt="${escapeHtml(p.nome)}">
            <div class="menu-item-content">
              <h3>${escapeHtml(p.nome)}</h3>
              <p class="price">${formatBRL(preco)}</p>
              <button class="add-to-cart-btn" data-id="${p.id}" data-name="${escapeHtml(p.nome)}" data-price="${preco}">Adicionar ao Carrinho</button>
            </div>
          `;
          menuList.appendChild(card);
        });

        // vincula evento adicionar
        document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
          btn.addEventListener('click', () => {
            addToCart(btn.dataset.id, btn.dataset.name, btn.dataset.price);
          });
        });

      } catch (err) {
        console.error(err);
        const menuList = document.getElementById("menu-list");
        menuList.innerHTML = `<p style="color:#b91c1c">N칚o foi poss칤vel carregar o card치pio. Verifique o servidor.</p>`;
      }
    }

    // escape simples para evitar inje칞칚o de HTML via nomes
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // adicionar item ao carrinho
    function addToCart(id, name, price) {
      price = Number(price);
      const existing = cart.find(i => String(i.id) === String(id));
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ id, name, price, quantity: 1 });
      }
      updateCartModal();
      Toastify({ text: `${name} adicionado ao carrinho`, duration: 1600 }).showToast();
    }

    // remover 1 unidade (ou remover item)
    function removeItemCart(id) {
      const idx = cart.findIndex(i => String(i.id) === String(id));
      if (idx === -1) return;
      if (cart[idx].quantity > 1) cart[idx].quantity -= 1;
      else cart.splice(idx, 1);
      updateCartModal();
    }

    // atualizar view do carrinho
    function updateCartModal() {
      const cartItems = document.getElementById('cart-items');
      const cartTotal = document.getElementById('cart-total');
      const cartCount = document.getElementById('cart-count');

      cartItems.innerHTML = '';
      total = 0;
      let totalQty = 0;

      if (cart.length === 0) {
        cartItems.innerHTML = '<p>Seu carrinho est치 vazio.</p>';
      } else {
        cart.forEach(item => {
          const itemEl = document.createElement('div');
          itemEl.className = 'cart-item';
          itemEl.innerHTML = `
            <div style="flex:1;">
              <div style="font-weight:700">${escapeHtml(item.name)}</div>
              <div style="color:#666">Qtd: ${item.quantity}</div>
            </div>
            <div style="text-align:right; min-width:100px;">
              <div style="font-weight:700">${formatBRL(item.price * item.quantity)}</div>
              <div style="margin-top:6px;">
                <button class="remove-from-cart-btn" data-id="${item.id}">Remover</button>
              </div>
            </div>
          `;
          cartItems.appendChild(itemEl);
          total += item.price * item.quantity;
          totalQty += item.quantity;
        });
      }

      cartTotal.textContent = formatBRL(total);
      // mostra quantidade total de unidades no bot칚o do carrinho
      cartCount.textContent = totalQty;
      
      // vincular bot칫es remover
      document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          removeItemCart(btn.dataset.id);
        });
      });
    }

    // abrir/fechar modal
    function openCart() {
      document.getElementById('cart-modal').style.display = 'flex';
      document.getElementById('cart-modal').setAttribute('aria-hidden', 'false');
      updateCartModal();
    }
    function closeCart() {
      document.getElementById('cart-modal').style.display = 'none';
      document.getElementById('cart-modal').setAttribute('aria-hidden', 'true');
    }

    // checkout: valida dados e envia pedido
    async function checkout() {
      if (cart.length === 0) {
        Toastify({ text: "O carrinho est치 vazio", duration: 1600 }).showToast();
        return;
      }

      const clienteNome = document.getElementById('cliente-nome').value.trim();
      const clienteTelefone = document.getElementById('cliente-telefone').value.trim();
      const endereco = document.getElementById('address').value.trim();
      const addressWarn = document.getElementById('address-warn');

      if (!clienteNome || !clienteTelefone || !endereco) {
        addressWarn.classList.remove('hidden');
        return;
      } else {
        addressWarn.classList.add('hidden');
      }

      const pedido = {
        cliente_nome: clienteNome,
        cliente_telefone: clienteTelefone,
        itens: cart,
        total: total,
        endereco: endereco
      };

      try {
        // monta mensagem primeiro
const itensMsg = cart.map(item => `${item.name} (x${item.quantity}) - R$${item.price.toFixed(2)}`).join('\n');
const msg = encodeURIComponent(
  `游꼵 Novo Pedido Big John Cookies:\n\n` +
  `游녻 Nome: ${clienteNome}\n` +
  `游 Telefone: ${clienteTelefone}\n` +
  `游닍 Pedido:\n${itensMsg}\n\n` +
  `游늸 Endere칞o: ${endereco}\n` +
  `游눯 Total: R$ ${total.toFixed(2)}`
);

const phone = '19986058820';

// ABRE primeiro
window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');

// depois salva no banco
const response = await fetch(API_PEDIDO, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(pedido)
});


        // resetar carrinho
        cart = [];
        updateCartModal();
        closeCart();
        document.getElementById('cliente-nome').value = '';
        document.getElementById('cliente-telefone').value = '';
        document.getElementById('address').value = '';

        Toastify({ text: "Pedido enviado! Obrigado.", duration: 2200 }).showToast();

      } catch (err) {
        console.error(err);
        alert('Erro ao enviar pedido. Tente novamente.');
      }
    }

    // === Event listeners iniciais ===
    document.addEventListener('DOMContentLoaded', () => {
      carregarProdutos();

      document.getElementById('cart-btn').addEventListener('click', openCart);
      document.getElementById('close-modal-btn').addEventListener('click', closeCart);
      document.getElementById('checkout-btn').addEventListener('click', checkout);

      // fechar modal ao clicar fora (opcional)
      document.getElementById('cart-modal').addEventListener('click', (e) => {
        if (e.target.id === 'cart-modal') closeCart();
      });
    });

  })();
  </script>
</body>
</html>
